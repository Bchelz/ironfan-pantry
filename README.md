Overview
========

Every Chef installation needs a Chef Repository. Chef Repository is the place where cookbooks, roles, config files and other artifacts for managing systems with Chef will live. We strongly advise you to store this repository in a version control system such as Git and to treat it like source code.

While we recommend Git, and make this repository available via GitHub, you are welcome to download a tar or zip archive and use your favorite version control system to manage the code.

Repository Organization
=======================

Chef Repository contains several directories, and each contains a README.md file describing its purpose and use in greater detail.

These are the main assets you'll use:

* `cookbooks/` - Cookbooks you download or create. Cookbooks install components, for example `cassandra` or `java`.
* `roles/`     - Roles organize cookbooks and attribute overrides to describe the specific composition of your system. For example, you install Cassandra attaching the `cassandra_server` role to your machine. (.rb or .json files)
* `clusters/`  - Clusters fully describe your machines, from its construction ('an 8-core machine on the Amazon EC2 cloud') to its roles ('install Cassandra, Ganglia for monitoring, and metachef to manage its logs and firewall').
* `vagrants/`  - Use VMs locally on your desktop to develop and test your clusters before deploying them.

These folders hold supporting files. You're less likely to visit here regularly.

* `knife/`        - Chef and cloud configuration and their myriad attendant credential files.
* `environments/` - Organization-wide attribute values. (.json files)
* `data_bags/` - Data bags are an occasionally-useful alternative to node metadata for distributing information to your machines. (.json files)
* `certificates/` - SSL certificates generated by `rake ssl_cert` live here.
* `tasks/`        - Rake tasks for common administrative tasks.
* `vendor/`       - cookbooks are checked out to `vendor`; symlinks in the `cookbooks/` directory select which ones will be deployed to chef server.

### Conventions

In all of the below,

* `{homebase}`: the directory that holds your chef cookbooks, roles and so forth. For example, this file is in `{homebase}/README.md`.

* `{username}` identifies your personal chef client name: the thing you use to log into the chef WebUI.

* `{organization}`: identifies the credentials set and cloud settings to use.  If your chef server is on the Opscode platform (try it! it's super-easy), use your organization name (the last segment of your chef_server url). If not, use an identifier you deem sensible.

Installation
============

1. Clone this repo. It will produce the directory we will call `homebase` from now on. In fact, you may wish to rename it:

        git clone https://github.com/infochimps-labs/cluster_chef-homebase 
        
**SYAFLAG: fatal error. cloning this will create a clone in the local machine, but will not allow for sharing or pushing back up to Git. So I forked my own branch and then cloned from ssh git@github.com.sya**

        mv cluster_chef-homebase homebase
        cd homebase
        git submodule update --init
        # (you may want to go into the submodule checkout(s) and switch each to its master branch)

**SYAFLAG: How can I do this ("go into submodule and switch each to its master branch") ? Need instructions.  "Would be good to expand this part later and/or automate..." (says Nate)**

2. Install the cluster_chef gem

**SYANOTE: Worth mentioning that it will take a minute?  Got Error: permission error.  Used sudo.**

        gem install cluster_chef

3. Set up your [knife.rb](http://help.opscode.com/faqs/chefbasics/knife) file.

  - _New to Chef_: If you don't have an existing chef setup, follow steps in
   [knife/README.md](https://github.com/infochimps-labs/cluster_chef-homebase/tree/public/knife/README.md)
   to set up `~/.chef` and its Credentials (`knife/{organization}-credentials`)
   folder. Be sure to set the environment variables in both your .bashrc and
   your current shell session:

**SYAFLAG: Instructions for how to do this necessary?**

        export CHEF_USER={username} CHEF_ORGANIZATION={organization} CHEF_HOMEBASE={homebase}

  - _Have a knife.rb_: add one line to your knife.rb, telling chef where to find
    your cluster definitions:

        cluster_path   [ "#{/path/to/your/homebase}/clusters" ]

5. You should now be able to knife cluster list, knife cluster launch and so forth:

        $ knife cluster list
        +--------------------+---------------------------------------------------+
        | cluster            | path                                              |
        +--------------------+---------------------------------------------------+
        | a_simple_cluster   | /cloud/clusters/a_simple_cluster.rb               |
        | burninator         | /cloud/clusters/burninator.rb                     |
        | el_ridiculoso      | /cloud/clusters/el_ridiculoso.rb                  |
        | elasticsearch_demo | /cloud/clusters/elasticsearch_demo.rb             |
        | hadoop_demo        | /cloud/clusters/hadoop_demo.rb                    |
        +--------------------+---------------------------------------------------+

        $ knife cluster launch a_simple_cluster --bootstrap
        # ...


Next Steps
==========

Read the README file in each of the subdirectories for more information about what goes in those directories.


Cookbook Versioning and Tracking
================================

This homebase groups all the repos we use, and is most 

* every cookbook has its own repo on [infochimps-cookbooks' github](http://github.com/infochimps-cookbooks) 
* They are all git-subtree'd into [this repo](http://github.com/infochimps-labs/cluster_chef-homebase): 
  - infochimps-maintained cookbooks: git-subtree from the infochimps-cookbooks home, placed in `vendor/infochimps`.
  - Other cookbooks: git-subtree from the infochimps-cookbooks fork, placed in `vendor/{original_author}`
  - Opscode community cookboks: *git submodule* of the [infochimps-labs](http://github.com/infochimps-labs/opscode_cookbooks) fork of opscode/cookbooks is into `vendor/opscode`. This holds *all* their cookbooks.
* The actual collection we use is defined by symlinks in `cookbooks/foo` to `../vendor/whatever/foo`. This is everything in vendor/infochimps, vendor/{other}, and the curated subset of things in vendor/opscode.
* Each cookbook's history is present in its solo repo as far back as the may 2011 re-org. However, that history shows up weird in the homebase -- this is a limitation in git that we can't work around.

We welcome pull requests against either homebase or the individual repo. Please only file issues at the [cluster_chef](https://github.com/infochimps/cluster_chef/issues) bug tracker though.

Rake Tasks
==========

The repository contains a `Rakefile` that includes tasks that are installed with the Chef libraries. To view the tasks available with in the repository with a brief description, run `rake -T`.

Besides your `~/.chef/knife.rb` file, the Rakefile loads `config/rake.rb`, which sets:

* Constants used in the `ssl_cert` task for creating the certificates.
* Constants that set the directory locations used in various tasks.

If you use the `ssl_cert` task, change the values in the `config/rake.rb` file appropriately. These values were also used in the `new_cookbook` task, but that task is replaced by the `knife cookbook create` command which can be configured below.

The default task (`default`) is run when executing `rake` with no arguments. It will call the task `test_cookbooks`.

The following standard chef tasks are typically accomplished using the rake file:

* `bundle_cookbook[cookbook]` - Creates cookbook tarballs in the `pkgs/` dir.
* `install` - Calls `update`, `roles` and `upload_cookbooks` Rake tasks.
* `ssl_cert` - Create self-signed SSL certificates in `certificates/` dir.
* `update` - Update the repository from source control server, understands git and svn.
* `roles` - iterates over the roles and uploads with `knife role from file`.

Most other tasks use knife: run a bare `knife cluster`, `knife cookbook` (etc) to find out more.
