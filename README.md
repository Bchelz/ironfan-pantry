Overview
========

Every Chef installation needs a Chef Repository. This is the place where cookbooks, roles, config files and other artifacts for managing systems with Chef will live. We strongly recommend storing this repository in a version control system such as Git and treat it like source code.

While we prefer Git, and make this repository available via GitHub, you are welcome to download a tar or zip archive and use your favorite version control system to manage the code.

Repository Directories
======================

This repository contains several directories, and each directory contains a README file that describes what it is for in greater detail, and how to use it for managing your systems with Chef.

* `certificates/` - SSL certificates generated by `rake ssl_cert` live here.
* `config/` - Contains the Rake configuration file, `rake.rb`.
* `cookbooks/` - Cookbooks you download or create.
* `data_bags/` - Store data bags and items in .json in the repository.
* `roles/` - Store roles in .rb or .json in the repository.

In all of the below, 

* `{username}` identifies your personal chef client name: the thing you use to log into the chef webui.
  
* `{organization}`: identifies the credentials set and cloud settings to use.  If your chef server is on the Opscode platform (try it! it's super-easy), use your organization name (the last segment of your chef_server url). If not, just use any sensible identifier.
  
* `{homebase}`: the directory that holds your chef cookbooks, roles and so forth. For example, this file is in `{homebase}/knife/README.md`.

Installation
============

1. Clone this repo, producing the directory we'll call `homebase` from now on. In fact, you may wish to rename it:

        git clone https://github.com/infochimps-labs/cluster_chef-homebase
        mv cluster_chef-homebase homebase
        cd homebase
        git submodule update --init

2. Install the cluster_chef gem

        gem install cluster_chef

3. Set up your [knife.rb](http://help.opscode.com/faqs/chefbasics/knife) file.

  - _New to Chef_: If you don't have an existing chef setup, follow steps in
   `knife/README.md` to set up your `~/.chef` and its credentials
   (`knife/{organization}`) folder. Make sure to set the environment variables
   in both your .bashrc and your current shell session:
   
        export CHEF_USER={username} CHEF_ORGANIZATION={organization} CHEF_HOMEBASE={homebase}
     
  - _Have a knife.rb_: add one line to your knife.rb, telling chef where to find
    your cluster definitions:

        cluster_path   [ "#{/path/to/your/homebase}/clusters"  ]
    
5. You should now be able to knife cluster list, knife cluster launch and so forth:
    
        $ knife cluster list
        +--------------------+---------------------------------------------------+
        | cluster            | path                                              |
        +--------------------+---------------------------------------------------+
        | a_simple_cluster   | /cloud/clusters/a_simple_cluster.rb               |
        | burninator         | /cloud/clusters/burninator.rb                     |
        | el_ridiculoso      | /cloud/clusters/el_ridiculoso.rb                  |
        | elasticsearch_demo | /cloud/clusters/elasticsearch_demo.rb             |
        | hadoop_demo        | /cloud/clusters/hadoop_demo.rb                    |
        +--------------------+---------------------------------------------------+
      
        $ knife cluster launch a_simple_cluster --bootstrap 
        # ...
    

Next Steps
==========

Read the README file in each of the subdirectories for more information about what goes in those directories.

Rake Tasks
==========

The repository contains a `Rakefile` that includes tasks that are installed with the Chef libraries. To view the tasks available with in the repository with a brief description, run `rake -T`.

Besides your `~/.chef/knife.rb` file, the Rakefile loads `config/rake.rb`, which sets:

* Constants used in the `ssl_cert` task for creating the certificates.
* Constants that set the directory locations used in various tasks.

If you use the `ssl_cert` task, change the values in the `config/rake.rb` file appropriately. These values were also used in the `new_cookbook` task, but that task is replaced by the `knife cookbook create` command which can be configured below.

The default task (`default`) is run when executing `rake` with no arguments. It will call the task `test_cookbooks`.

The following standard chef tasks are typically accomplished using the rake file:

* `bundle_cookbook[cookbook]` - Creates cookbook tarballs in the `pkgs/` dir.
* `install` - Calls `update`, `roles` and `upload_cookbooks` Rake tasks.
* `ssl_cert` - Create self-signed SSL certificates in `certificates/` dir.
* `update` - Update the repository from source control server, understands git and svn.
* `roles` - iterates over the roles and uploads with `knife role from file`.

Most other tasks use knife: run a bare `knife cluster`, `knife cookbook` (etc)
to find out more.
