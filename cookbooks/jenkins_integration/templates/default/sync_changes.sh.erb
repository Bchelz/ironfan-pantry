#!/usr/bin/env bash
#
# Synchronize code that has changed to the Chef server.
#
source `dirname $0`/shared.inc

cd $TEST_PATH

echo "Getting staging cookbooks:"
pantry_branch "staging"
git checkout staging
bundle exec berks install --path staged_cookbooks; echo
echo

echo "Getting testing cookbooks:"
pantry_branch "testing"
git checkout testing
bundle exec berks install --path cookbooks; echo
echo

echo "Uploading changed cookbooks:"
changed=''
echo > $CHANGED_COOKBOOKS
for cookbook in `ls -1d cookbooks/*/ | cut -d/ -f2`; do
  cb_path=cookbooks/$cookbook
  # Don't treat a removed cookbook as changed
  test_path="[ -d $cb_path ]"
  find_change="diff -qr $cb_path staged_$cb_path"
  # Look only for differences that *aren't* VERSION bumps
  real_change="! $find_change | grep -v VERSION > /dev/null"
  if $test_path && $real_change; then
    changed="$changed$cookbook "
  fi
done
if [ "nothing$changed" == "nothing" ]; then
  echo "Nothing changed - very suspicious"
  exit 1
fi
echo $changed > $CHANGED_COOKBOOKS
knife cookbook upload $changed
echo

echo "Uploading changed roles:"
changed=''
for file in `git diff --name-only staging roles/`; do
  # Don't treat a removed role as changed
  if [ -f $file ]; then 
    rake role from file $file
    changed="$changed$file "
  fi
done
if [ "nothing$changed" == "nothing" ]; then
  echo "Nothing changed"
fi
echo
