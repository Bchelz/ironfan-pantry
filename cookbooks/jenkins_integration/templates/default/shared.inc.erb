#
# Core components
# 
ROOT_DIR=`dirname $0`
WORKSPACE=$ROOT_DIR/workspace

#
# Repositories
# 
<%- def repo_name(repo)
      repo[/\/([a-z-]*)\.git/,1]
    end
    def repo_names(repo)
      repo.map {|r| repo_name r }.join(' ')
    end %>
export REPOS="<%= @repositories.join(' ') %>"
export PANTRIES="<%= repo_names node[:jenkins_integration][:ironfan_ci][:pantries] %>"
export HOMEBASES="<%= repo_names node[:jenkins_integration][:ironfan_ci][:homebases] %>"
export TEST_PATH="<%= repo_name node[:jenkins_integration][:ironfan_ci][:test_homebase] %>"
export ALL_PATHS="$PANTRIES $HOMEBASES"

export USE_LOCAL=true
export LOCAL_PATH=..
function switch_to {
  cd $WORKSPACE/$1; pwd
}
function ensure_bundle {
  if ! bundle check; then
    echo "Installing bundle:"
    PARAMS="--path $WORKSPACE/vendor --no-color --without=development,support"
    # Only install from source if cache fails
    bundle install $PARAMS --local || bundle install $PARAMS
  fi
}
function change_all_branches {
  echo "Switching to $1 on all repos:"
  for name in $ALL_PATHS; do
    switch_to $name
    git checkout -f $1
    cd - > /dev/null
  done
}
function install_berkshelves {
  echo "Installing cookbooks at $1"
  for name in $HOMEBASES; do
    switch_to $name
    ensure_bundle
    bundle exec berks install --path $1; echo
  done
}


# 
# Launch
# 
export MAX_WAIT=<%= node[:jenkins_integration][:ironfan_ci][:max_wait] %>
export CHEF_USER=<%= node[:jenkins_integration][:ironfan_ci][:chef_user] %>

function knife {
  bundle exec knife "$@"
}

