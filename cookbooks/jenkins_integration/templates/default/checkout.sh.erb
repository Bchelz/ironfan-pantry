#!/usr/bin/env bash
source `dirname $0`/shared.inc
set -e

echo "Getting all repositories (inc. bundled code & branches) up-to-date: $REPOS"
echo

for repo in $REPOS; do
  name=${repo##*/}
  name=${name%.git}

  cd $WORKSPACE
  if [ ! -d $name ]; then
    echo "Checking out $repo:"
    git clone $repo
    switch_to $name

    echo "get remotes:"
    for remote in `git branch -r | grep -v origin/master`; do
      git checkout -t remotes/$remote
    done
  else
    echo "Updating $repo:"
    switch_to $name
    git checkout -f master
    git pull

    echo "update remotes:"
    for remote in `git branch -r | grep -v origin/master`; do
      git checkout -f ${remote#*/}
      git pull
    done
  fi

  echo "Get submodules"
  git checkout -f master
  git submodule update --init

  ensure_bundle
  echo
done
