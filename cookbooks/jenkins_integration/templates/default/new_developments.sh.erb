#!/usr/bin/env bash
# Are there changes to test in the pantries?
source `dirname $0`/shared.inc

REPOS="<%= node[:jenkins_integration][:ironfan_ci][:pantries].join(' ') %>"

for repo in $REPOS; do
  $ROOT_DIR/checkout.sh $repo
done

# Only continue if something needs testing
EXIT_CODE=1
for name in $PANTRIES; do
  cd $WORKSPACE/$name
  pwd
  if ! git diff --quiet master staging; then
  fi

  echo "find all cookbook differences between master and staging:"
  changes=`git diff --name-only staging -- cookbooks/*/ | cut -d/ -f2 | sort | uniq`
  if [ "x$changes" = "x" ]; then
    echo "No cookbook changes between master and staging"
    continue
  fi

  echo "Changes found"
  echo $changes
  if [ $EXIT_CODE == "1" ]; then EXIT_CODE=0; fi

  echo "ensure each change includes a version bump in master:"
  git checkout master
  git pull
  for cookbook in $changes; do
    if ! git diff --quiet staging -- cookbooks/$cookbook/VERSION; then
      "ERROR: changes found but no version bump in $cookbook"
      EXIT_CODE=2
    fi
  done
  echo

done

if [ $EXIT_CODE == "1" ]; then echo "ERROR: No changes found for testing"; fi
exit $EXIT_CODE
