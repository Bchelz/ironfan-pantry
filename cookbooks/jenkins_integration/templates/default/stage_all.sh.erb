#!/usr/bin/env bash
set -e

source `dirname $0`/shared.inc

function matroshka {
  echo Push the testing branch into the staging one. Ensure that staging remains a
  echo subset of testing, which remains a subset of master, by also pulling in
  echo changes from those branches. If this all works, push the results to origin.
  git checkout -f staging
  git merge testing

  git checkout -f testing
  git merge staging

  git checkout -f master
  git pull              # There may be development changes
  git merge testing

  git push
  echo
}

# Advance all the successfully tested code to staging
for name in $ALL_REPOS; do
  cd $WORKSPACE/$name; pwd
  matroshka
done

# Advance the staging environments to use successfully tested code
for name in $HOMEBASES; do
  cd $WORKSPACE/$name; pwd
  git checkout -f staging
  knife environment from file staging.rb
  git commit $VERSIONS -m"$VERSIONS: updating staged versions"
done

echo "Everything has converged successfully. Enjoy your new staging version."
