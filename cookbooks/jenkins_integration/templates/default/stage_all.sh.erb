#!/usr/bin/env bash -e
source `dirname $0`/shared.inc

changed=`cat changed_cookbooks`

pantry_branch "testing"

for homebase in $HOMBASES; do
  pushd $homebase
    # Install testing cookbooks, upload and freeze those which changed this run
    time bundle exec berks install --path cookbooks
    time knife cookbook upload --freeze $changed

    # Record the cookbook versions to the staging evnironment
    git checkout staging
    VERSIONS=environments/_cookbooks.rb
    echo -n > $VERSIONS
    for target in `ls -1d cookbooks/*`; do
      cookbook=${target#cookbooks/}
      echo -e "\$versions['$cookbook']\t= '`cat cookbooks/$cookbook/VERSION`'" >> $VERSIONS
    done
    knife environment from file environments/staging.rb
    git commit $VERSIONS -m"$VERSIONS: updating staged versions"
    git push

    # Ensure that staging remains a subset of testing, which remains a subset of master
    git checkout testing
    git merge staging
    git push
    git checkout master
    git merge testing
    git push
  popd
  echo
done

for pantry in $PANTRIES; do
  pushd $pantry
    git checkout staging
    git merge testing
    git push
  popd
  echo
done
