#!/usr/bin/env bash
set -o errexit

source `dirname $0`/shared.inc

h1 "Advance testing code to staging, ensuring matryoshka remains intact:"
change_all_branches "staging"
for name in $ALL_REPOS; do
  h2 `switch_to $name`
  git merge testing

  git checkout -f testing
  git merge staging

  git checkout -f master
  git pull              # There may be development changes
  git merge testing

  git push
done

h1 "Upload the new staging environments:"
for name in $HOMEBASES; do
  h2 `switch_to $name`
  git checkout -f staging
  knife environment from file staging.rb
done

success "Everything has converged successfully. Enjoy your new staging version."
