#!/usr/bin/env bash
set -e

source `dirname $0`/shared.inc

echo "Advance testing code to staging, ensuring matryoshka remains intact:"
switch_all_branches "staging"
for name in $ALL_REPOS; do
  switch_to $name
  git merge testing

  git checkout -f testing
  git merge staging

  git checkout -f master
  git pull              # There may be development changes
  git merge testing

  git push
  echo
done

echo "Upload the new staging environments:"
for name in $HOMEBASES; do
  switch_to $name
  git checkout -f staging
  knife environment from file staging.rb
  echo
done

echo "Everything has converged successfully. Enjoy your new staging version."
