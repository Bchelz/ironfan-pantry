#!/usr/bin/env bash
set -e

source `dirname $0`/shared.inc

changed=`cat $ROOT_DIR/changed_cookbooks`

pantry_branch "testing"

for homebase in $HOMEBASES; do
  cd $WORKSPACE/$homebase
  # Install testing cookbooks, upload and freeze those which changed this run
  bundle exec berks install --path cookbooks
  knife cookbook upload -V --freeze $changed

  # Record the cookbook versions to the staging evnironment
  git checkout staging
  VERSIONS=environments/cookbook_versions.rb
  cat $ROOT_DIR/cookbook_versions.rb.h > $VERSIONS
  for target in `ls -1d cookbooks/*`; do
    cookbook=${target#cookbooks/}
    version=`cat cookbooks/$cookbook/VERSION`
    echo -e "\$cookbooks['$cookbook']\t= '$version'" >> $VERSIONS
  done
  knife environment from file staging.rb
  git commit $VERSIONS -m"$VERSIONS: updating staged versions"

  # Ensure that staging remains a subset of testing, which remains a subset of master
  git merge testing
  git checkout testing
  git merge staging
  git checkout master
  git pull
  git merge testing
  git push

  # Clean up the working directory
  rm -r staged_cookbooks/ tmp.client.log
  echo
done

for pantry in $PANTRIES; do
  cd $WORKSPACE/$pantry
  git checkout staging
  git merge testing
  git checkout master
  git pull
  git merge testing
  git push
  echo
done
