#!/usr/bin/env bash
# Bump the pantries from master to staging
source `dirname $0`/shared.inc

REPOS="<%=( node[:jenkins_integration][:ironfan_ci][:pantries] +
            node[:jenkins_integration][:ironfan_ci][:homebases] ).join(' ') %>"

for repo in $REPOS; do
  $ROOT_DIR/checkout.sh $repo
done

for name in $ALL_PATHS; do
  cd $WORKSPACE/$name
  $ROOT_DIR/bundler.sh
done

# FIXME: We should probably have a framework in the homebases
#   too; build it as soon as actual need arises
for name in $PANTRIES; do
  cd $WORKSPACE/$name

  echo "ensure master is clean:"
  git checkout master
  git status | grep 'nothing to commit (working directory clean)'
  if [ $? -ne '0' ]; then
    echo "FATAL: master branch is not clean" >&2
    exit 1
  fi
  echo

  echo "ensure master is in sync with origin:"
  git pull
  #git push  # FIXME: BAAAD - kill it or make it right
  git status | grep 'Your branch is '
  if [ $? -ne '1' ]; then
    echo "FATAL: master branch isn't in sync with origin/master" >&2
    exit 1
  fi
  echo

  echo "make sure master is a descendant of testing:"
  git merge testing | grep 'Already up-to-date'
  if [ $? -ne '0' ]; then
    echo "FATAL: master is not a descendant of testing" >&2
    exit 1
  fi
  echo

  echo "find all cookbook differences between master and testing:"
  CHANGES=`git diff --name-only testing -- cookbooks/*/ | cut -d/ -f2 | sort | uniq`
  if [ "x$CHANGES" = "x" ]; then
    echo "No cookbook changes between master and testing"
    continue
  fi
  echo $CHANGES
  echo

  echo "ensure each change includes a version bump:"
  for cookbook in `echo "$CHANGES"`; do
    git diff --name-only testing -- cookbooks/$cookbook/VERSION | grep -q VERSION
    if [ $? -ne '0' ]; then
      echo "bumping $cookbook"
      rake $cookbook:version:bump
    fi
  done
  echo

  echo "push the changes forward into testing"
  git checkout testing
  git merge master
  git checkout master
  git push origin master        # Just the HEAD, baby (not any changes to testing, etc.)
  echo

  echo "DONE"
done
