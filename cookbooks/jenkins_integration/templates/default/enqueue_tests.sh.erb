#!/usr/bin/env bash
# Prepare the pantries and homebases for cookbook testing
source `dirname $0`/shared.inc

REPOS="<%=( node[:jenkins_integration][:ironfan_ci][:pantries] +
            node[:jenkins_integration][:ironfan_ci][:homebases] ).join(' ') %>"

for repo in $REPOS; do
  $ROOT_DIR/checkout.sh $repo
done

# FIXME: These probably need to be expanded for all repos
for name in $PANTRIES; do
  cd $WORKSPACE/$name
  pwd

  echo "make sure master is a descendant of testing:"
  git merge testing | grep 'Already up-to-date'
  if [ $? -ne '0' ]; then
    echo "FATAL: master is not a descendant of testing" >&2
    exit 1
  fi
  echo

  echo "find all cookbook differences between master and staging:"
  changes=`git diff --name-only staging -- cookbooks/*/ | cut -d/ -f2 | sort | uniq`
  if [ "x$changes" = "x" ]; then
    echo "No cookbook changes between master and staging"
    continue
  fi
  echo $changes
  echo

  echo "push the changes forward into testing"
  git checkout testing
  git merge master
  echo

  echo "ensure each change includes a version bump in master:"
  git checkout master
  git pull
  for cookbook in $changes; do
    echo "bumping $cookbook"
    rake $cookbook:version:bump
  done
  # Just the HEAD, baby (not any changes to testing, etc.)
  git push origin master
  echo
done
