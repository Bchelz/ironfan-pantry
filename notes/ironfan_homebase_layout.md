Ironfan Homebase Layout
=========================

Chef Homebase contains several directories, and each contains a README.md file describing its purpose and use in greater detail.

These are the main assets you'll use:

* `cookbooks/`  - Cookbooks you download or create. Cookbooks install components, for example `cassandra` or `java`.
* `roles/`      - Roles organize cookbooks and attribute overrides to describe the specific composition of your system. For example, you install Cassandra attaching the `cassandra_server` role to your machine. (.rb or .json files)
* `clusters/`   - Clusters fully describe your machines, from its construction ('an 8-core machine on the Amazon EC2 cloud') to its roles ('install Cassandra, Ganglia for monitoring, and metachef to manage its logs and firewall').

These folders hold supporting files. You're less likely to visit here regularly.

* `knife/`        - Chef and cloud configuration and their myriad attendant credential files.
* `environments/` - Organization-wide attribute values. (.json or .rb files)
* `data_bags/`    - Data bags are an occasionally-useful alternative to node metadata for distributing information to your machines. (.json files)
* `certificates/` - SSL certificates generated by `rake ssl_cert` live here.
* `tasks/`        - Rake tasks for common administrative tasks.
* `vendor/`       - cookbooks are checked out to `vendor`; symlinks in the `cookbooks/` directory select which ones will be deployed to chef server.

You may also wish to explore

* `ironfan-ci/` - Use VMs locally on your desktop to develop and test your clusters before deploying them.

Cookbook Versioning and Tracking
================================

This homebase groups all the repos we use, and is most 

* every cookbook has its own repo on [infochimps-cookbooks' github](http://github.com/infochimps-cookbooks) 
* They are all git-subtree'd into [this repo](http://github.com/infochimps-labs/ironfan-homebase): 
  - infochimps-maintained cookbooks: git-subtree from the infochimps-cookbooks home, placed in `vendor/infochimps`.
  - Other cookbooks: git-subtree from the infochimps-cookbooks fork, placed in `vendor/{original_author}`
  - Opscode community cookboks: *git submodule* of the [infochimps-labs](http://github.com/infochimps-labs/opscode_cookbooks) fork of opscode/cookbooks is into `vendor/opscode`. This holds *all* their cookbooks.
* The actual collection we use is defined by symlinks in `cookbooks/foo` to `../vendor/whatever/foo`. This is everything in vendor/infochimps, vendor/{other}, and the curated subset of things in vendor/opscode.
* Each cookbook's history is present in its solo repo as far back as the may 2011 re-org. However, that history shows up weird in the homebase -- this is a limitation in git that we can't work around.

We welcome pull requests against either homebase or the individual repo. Please only file issues at the [ironfan](https://github.com/infochimps/ironfan/issues) bug tracker though.

## Overview

The cluster_chef toolset takes chef to the next level:

* `cluster_chef` gem: assembles machines and roles into a working cluster using a clean, expressive domain-specific language.
* `cluster_chef-knife` knife plugin: orchestrate clusters of machines, in the cloud or VMs.
* `cluster_chef-homebase`: Our collection of industrial-strength, cloud-ready recipes for Hadoop, HBase, Cassandra, Elasticsearch, Zabbix and more.
* the `metachef` cookbook: coordinate discovery of services ("list all the machines for `awesome_webapp`, that I might load balance them") and aspects ("

## Directory setup

We recommend you set up your 

    /path/to/{organization}-chefrepo
    │  
    ├── clusters
    │   └── { actual clusters }
    │  
    ├── roles
    │   ├── { roles }
    │   └── { symlinks into vendor/cluster_chef/roles }
    │  
    ├── site-cookbooks                  - directories holding internal cookbooks
    │   └── users
    │  
    ├── cookbooks                       - symlinks to externally maintained cookbooks
    │   ├── @vendor/opscode/...
    │   └── @vendor/cluster_chef/...
    │  
    ├── vendor
    │   ├── opscode
    │   │   └── cookbooks               - git submodule of https://github.com/opscode/cookbooks
    │   │  
    │   └── cluster_chef                - git submodule of https://github.com/infochimps/cluster_chef
    │       ├── site-cookbooks          - systems:     hadoop, cassandra, provides_service, etc.
    │       ├── integration-cookbooks   - integration: connects systems together
    │       ├── meta-cookbooks          - utilities:   provides_service, system_params, can_haz
    │       │  
    │       ├── roles
    │       │  
    │       └── examples
    │           ├── clusters            - example clusters
    │           └── roles               - roles that go with the example clusters
    │  
    ├── certificates
    ├── config
    ├── data_bags
    └── environments

## Knife dir setup

    ~/.chef
    │  
    ├── knife.rb
    ├── knife-user-{user}.rb            - your user-specific knife customizations
    ├── {user}.pem                      - your chef client key
    ├── {organization}-validator.pem    - chef validator key, used to create client keys
    ├── {organization}-credentials.rb   - secret credentials: aws_secret_access_key, etc. Do not version.
    ├── {organization}-cloud.rb      .  - cloud assets: elastic IPs, AMI image ids, etc
    ├── {organization}-keypairs
    │   ├── bonobo.pem
    │   ├── gibbon.pem
    │   ├── client-bonobo-worker-0.pem
    │   └── client-bonobo-worker-0.pem
    └── .gitignore                      - make sure not to version the secret/user-specific stuff (*-keypairs, *-credentials.rb, knife-user-*.rb)

For example, I am user `mrflip` and my organization is `infochimps`, so my tree looks like:

    knife_dir
    │  
    ├── knife.rb
    ├── knife-user-mrflip.rb            
    ├── mrflip.pem                      
    ├── infochimps-validator.pem    
    ├── infochimps-credentials.rb   
    ├── infochimps-cloud.rb      .  
    ├── infochimps-keypairs
    │   ├── bonobo.pem
    │   ├── gibbon.pem
    │   ├── client-bonobo-master-0.pem
    │   └── client-bonobo-worker-1.pem
    └── .gitignore                      

